# Chapter 10. 이벤트



### 시스템 간 강결합의 문제

1. 외부 서비스가 정상이 아닐 경우
2. 성능 - 외부 시스템의 응답 시간이 길어지면 그만큼 대기시간 발생

강한 결합을 없앨 수 있는 방법 => 이벤트를 사용 (특히 비동기 이벤트)



### 이벤트

과거에 벌어진 사건



#### 이벤트 관련 구성요소

이벤트 생성 주체 => 이벤트 디스패처  (이벤트 퍼블리셔) => 이벤트 핸들러 (이벤트 구독자)

이벤트 핸들러: 이벤트 생성 주체가 발생한 이벤트에 반응한다.

이벤트 디스패처 : 이벤트 생성 주체와 이벤트 핸들러를 연결 => 이벤트 생성주체는 이벤트를 생성해 디스패처에 이벤트를 전달함. 디스패처는 이벤트를 처리할 수 있는 핸들러에 이벤트 전파



#### 이벤트의 구성

- 이벤트의 종류: 클래스 이름
- 이벤트의 발생 시간
- 추가 데이터 : 주문 번호, 신규 배송지 정보 등 이벤트 관련 정보



#### 이벤트 용도

- 트리거 : 도메인의 상태가 바뀔 때 다른 후처리를 해야 할 경우 후처리를 실행하기 위한 트리거로 이벤트를 사용 > ~ 할때 ~한다
- 서로 다른 시스템 간의 데이터 동기화 



### 이벤트, 핸들러, 디스패처 구현

- 이벤트 클래스 : 과거에 벌어진 상태 변화나 사건
- EventHandler : 이벤트 핸들러를 위한 상위 타입으로 모든 핸들러는 이 인터페이스를 구현한다.
- Events : 이벤트 디스패처, 이벤트 발행, 이벤트 핸들러 등록, 이벤트를 핸들러에 등록하는 등의 기능 제공



#### 이벤트 클래스

과거 시제를 사용해야한다. (이벤트 == 과거에 벌어진 상태 변화나 사건을 의미함)

모든 이벤트가 공통으로 갖는 프로퍼티가 존재하면 관련 상위 클래스를 만들 수도 있다.

```
OrderCanceledEvent <- Event
```



#### EventHandler 인터페이스

handler() 메서드: 필요한 기능 구현

canHandle() 메서드 : 핸들러가 이벤트를 처리할 수 있는지 여부를 검사함



#### 이벤트 디스패처인 Events 구현

Events.raise()를 이용해 이벤트를 발생

Events.raise()는 등록된 핸들러의 canHandle()을 이용해 이벤트를 처리할 수 있는 지 확인하고, 이벤트를 처리.

도메인 기능 실행을 끝내고 리턴

Events.reset()을 이용해 ThreadLocal을 초기화



스레드 핸들러가 담고있는 List에 계속 핸들러 객체가 쌓이게되어 메모리 부족 에러가 발생할 수 있기 때문에. ThreadLocal에 보관된 값을 보관.



#### AOP를 이용한 Event.reset() 실행

aop를 이용하여 공통적으로 ThreadLocal에서 삭제하는 부분을 삭제할 수 있다.



### 동기 이벤트 처리문제

외부 서비스에 영향을 받는 문제 (성능)

외부 시스템과의 연동을 동기로 처리할 때 발생하는 성능과 트랜잭션 범위문제 해소 => 이벤트를 비동기로 처리



### 비동기 이벤트 처리

'A하면 최대 언제까지 B하라' : 후속 조치를 바로 할 필요 없이 일정 시간 안에만 처리하면 되는 경우



#### 로컬 핸들러의 비동기 실행

이벤트 핸들러를 별도 스레드로 실행하는 것

ExecutorService를 사용하여 스레드 풀에 핸들러 실행 작업을 등록한다.

별도 스레드를 이용해서 이벤트 핸들러를 실행하면 이벤트 발생 코드와 같은 트랜잭션 범위에 묶을 수 없다. (한 트랜잭션으로 실행해야하면 비동기로 처리해서는 안된다.)



#### 메시징 시스템을 이용한 비동기 구현

이벤트가 발생하면 이벤트 디스패처는 이벤트를 메시지 큐에 보내고, 메시지 큐는 이벤트를 메시지 리스너에 전달하고, 메시지 리스너는 알맞는 이벤트 핸들러를 이용해서 이벤트를 처리한다.

이벤트 발생 JVM과 이벤트 처리 JVM이 다른 경우가 보통이다.



#### 이벤트 저장소를 이용한 비동기 처리

이벤트를 일단 DB에 저장한 뒤에 별도 프로그램을 이용해 이벤트 핸들러에 전달하는 것 (outbox 패턴)

포워더 : 이벤트를 주기적으로 읽어와 전달. 어디까지 전달했는지 추적함.
포워더를 이용해 이벤트를 외부에 전달하는 방식
이벤트를 어디까지 처리했는지 추적하는 역할

API방식 : REST와 같은 방식으로 이벤트를 외부에 제공, 이후 이벤트 핸들러가 API를 통해 이벤트를 읽어와 처리
외부 핸들러가 API서버를 통해 이벤트 목록을 가져오는 방식
이벤트 목록을 요구하는 외부 핸들러가 자신이 어디까지 이벤트를 처리했는지 기억해야함



### 이벤트 적용 시 추가 고려사항

- 포워더에서 전송 실패를 얼마나 허용할 것이냐 

  포워더 구현시 실패한 이벤트의 재 전송 횟수에 제한
  해당 이벤트를 생략하고, 다음 이벤트로 넘어가는 등의 정책으로 하는 등

- 이벤트 손실

  이벤트를 비동기로 처리할 경우 이벤트 처리에 실패하면 이벤트를 유실하게 된다.

- 이벤트 순서

  이벤트를 발생 순서대로 외부 시스템에 전달해야할 경우 이벤트 저장소를 사용하는 것이 좋다.
  반면 메시징 시스템은 사용 기술에 따라 이벤트 발생 순서와 메시지 전달 순서가 다를 수 있다.

- 이벤트 재처리

  동일한 이벤트를 다시 처리해야할 때 이벤트를 어떻게 할지 결정해야한다.
  이미 처리한 순번의 이벤트는 무시, 혹은 이벤트 처리를 멱등하게 처리한다.