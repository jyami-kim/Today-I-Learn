# 알아두면 언젠간 깨닫는 도커지식 1

feat 영우찡



### 서버 가상화

가상화에는 두가지 종류가 있다.

1. 하이퍼 바이저 가상화
2. 컨테이너 가상화



#### 하이퍼바이저 가상화

**하이퍼바이저 기반의 가상화**를 사용할 경우에는 내 서버 위에 host OS를 설치하고, 사용할 만큼만 자원을 분할하여 가상머신을 생성한 후에 그 위에 Guest OS를 설치하여 그 위에서  어플리케이션을 사용한다.

하지만 하이퍼바이저 기반 가상화의 경우엔 vm마다 자원을 따로따로 분리해서 사용을하는데, 중복된 자원이 있을 경우엔 사실 불필요한 용량(자원)을 소모한다고 볼 수 있다.



#### 컨테이너 가상화

따라서 이 OS 기반 가상화 기술을 대체할 수 있게 나온것이 **Container 기술**이다 이 컨테이너 기술은 LXC(linux Containers)라고 부르며 이 LXC 기술을 잘 활용해서 만든 것이 Docker이다.



![docker](/Users/jyami/Documents/today-I-learned/resource/docker.png)



도커환경에서는 아래 그림처럼 Guest OS가 필요하지 않다. 쉬운 이해를 위해 예를 들어보자

##### Host OS가 Cent OS이고, Ubuntu에서 application을 실행하고 싶다.

- 하이퍼 바이저에서는, GuestOS인 Ubuntu를 설치하고 그 위에서 app을 실행한다. 그러면 Guest OS에 있는 Kernel이 하이퍼 바이저에 명령을 전달하고 하이퍼 바이저가 다시 Cent OS의 Kernel로 명령어를 전달한다. 

  사실 이때만 봐도 커널과, OS가 각각 2개이다 (많은 리소스를 소모한다) 

  이때 하이퍼 바이저는 논리적으로 CPU와 Memory 자원을 분리하는 역할을 한다.

- 반면 도커엔진은 Guest OS인 Ubuntu와 Ubuntu의 Kernel 없이 앱의 명령을 내 host OS인 Cent OS의 kernel에 전달 할 수 있다.

  이는 도커엔진이 Ubuntu(guest OS) 위에서 실행되는 app의 명령어를 Cent OS(host OS) kernel이 이해할 수 있게 바꿔주는 역할을 하기 때문이다.

  하이퍼 바이저와 비교해서 리소스 소모가 훨씬 적다.



하이퍼 바이저와는 다르게 도커는 커널을 설치하지 않아, 베이스 이미지에도 커널이 없다. 따라서 하이퍼바이저에서 서버를 설치할 때 쓰는 윈도우나 리눅스 이밎 파일(iso)에 비해서 도커 이미지는 (베이스 이미지 조차도) 훨씬 가볍다

가벼운만큼 설치가 엄청 빠르다!!! (컨테이너 환경은 가볍다)



### LXC(Linux Containers)

컨테이너 환경이 실제 메모리 상에 어떤식으로 저장될지를 생각해보면,

리눅스에 프로세스의 네임스페이스를 다르게 해서 분리해둔 것이라고 생각하면된다. 리눅스에 격리 구역을 만들어서 서로 엉키지 않게 분리해놓고 그냥 프로세스를 실행하는 것이다

이 작업들을 **LXC**가 해준다



LCX는 리눅스 커널 컨테이너 기능을 위한 사용자 영역 인터페이스다. 리눅스 사용자가 쉽게 시스템과 어플리케이션의 컨테이너들을 생성/관리 할 수 있게 해준다.

공식문서에 따르면 아래와 같은 기능이 있다 한다. ~~(근데 읽어도 솔직히 잘 모르겠다)~~

- 커널 네임스페이스 (ipc, uts, 마운트, pid, 네트워크, 사용자)
- Apparmor와 SELinux 프로파일
- Seccomp 정책
- Chroots (pivot_root 사용)
- 커널 캐퍼빌리티
- CGroups (컨트롤 그룹)



그래서 그냥 컨테이너 환경에서는 도커 위에 올라간 코드를 돌린다는 것은

1. LCX를 통해 리눅스 커널안에 Cgroup이라는 구분자와 NameSpace라는 구분자를 결합하여 격리된 구역을 만든다.
2. 해당 격리 구역에 있는 코드를 도커엔진은 LXC를 사용하여 격리된 구역 안에서 프로그램을 실행한다.
3. 즉, 도커엔진이 리눅스에서 돌 때 LXC를 사용하여 위에 말한 host OS kernel 명령어로의 치환이 이루어 지고 구역을 격리시킨다는 것이다

> 첨언하자면 옛날의 윈도우의 도커는 
>
> 하이퍼바이저위에 geust OS로 리눅스를 설치하고 그위에서 도커엔진을 돌렸다고한다 (리소스 절약이 없었을 것)
>
> 요즘엔 그냥 된다고 한다.(최근 윈도우에 리눅스 커널[WSL]이 들어왔다고..~~mac유저라 관심이 없었음~~)

