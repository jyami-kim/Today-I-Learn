# Chapter10. 마이크로서비스 테스트 2부

### 1. 통합 테스트 작성

통합테스트의 두가지 전략

- 각 서비스의 어댑터(가능하면 그 어댑터의 지원클래스까지)를 테스트
- 계약을 활용하는 전략 (계약 = 상호작용의 구체적인 사례)
  - 소비자 쪽 테스트 : 컨슈머의 어댑터에 대한 테스트 - 프로바이더를 모킹한 스텁구성가능
  - 프로바이더 쪽 테스트 : 프로바이더의 어댑터에 대한 테스트 - 어댑터의 디펜던시를 목으로 잡고 계약으로 어댑터 테스트



#### 10.1.1 통합 테스트: 영속화

- 설정
- 실행
- 확인
- 정리

영속화 통합 테스트에서 사용된 DB를 어떻게 프로비저닝 하는가 : 도커 컴포즈 그레들(docker compose gradle) 플러그인 > 컴포넌트 테스트 수행 도중 서비스를 자동으로 실행

이 책에서는 스프링 클라우드 컨텍스트를 이용한 테스트 코드를 예시로 보여주고 있다.

- REST 요청/응답형 상호작용
- 발행/구독 스타일 상호작용
- 비동기 요청/응답 상호작용



통합테스트는 자신의 클라이언트디펜던시와 올바르게 소통하는지를 테스트함.

단위테스트는 서비스 로직이 정확한지를 테스트함



### 2. 컴포넌트 테스트 개발

서비스 인수테스트는 컴포넌트 테스트를 이용해 작성하는게 효율적이다.

거킨(Gherkin)이라는 테스트 DSL 사용



#### 10.2.1. 인수 테스트 정의

인수테스트 

- 소프트웨어 컴포넌트 비즈니스와 연관된 테스트.
- 사용자 스토리나 유스 케이스에서 출발해 내부 구현이 아닌 컴포넌트의 클라이언트 관점에서 어떤 동작이 외부에 드러나야 하는지 기술함



#### 10.2.2. 인수테스트 작성: 거킨

- 한서비스의 거킨 명세는 다수의 피쳐로 구성
- 각 피쳐는 여러 시나리오로 기술
- 각 시나리오는 given-when-then 구조를 갖고있음
- 큐컴버는 커킨으로 작성한 테스트를 실행하는 자동화 테스트 프레임워크이다.



#### 10.2.3. 컴포넌트 테스트 설계

##### 인-프로세스 컴포넌트 테스트 (in-process component test)

인-메모리 스텁과 목 디펜던시로 서비스를 실행함 

ex. 스프링 부트 테스트 프레임워크로 스프링 부트 기반 서비스의 컴포넌트 테스트를 작성하는 것



##### 아웃-오브-프로세스 컴포넌트 테스트 (out-of-process component test)

DB, 메시지 브로커 등은 실제 인프라 서비스를 사용하고, 애플리케이션 서비스 형태의 디펜던시는 스텁으로 대신 함

테스트 커버리지가 향상된다는 장점이 있다.

스텁이 요청 치리 및 응답 반환을 대신하도록, 이런 종류의 디펜던시에 스텁을 구성해야함



#### 10.2.4. 컴포넌트 테스트 작성

컴포넌트 테스트는 실행 속도가 느린편이다. : 테스트 코드를 src/component-test/java 별도 디렉터리에 넣고 ./gradlew/componentTest 명령을 실행하는 것이 좋다.

- 컴포넌트 테스트 직전에 그래들 도커 컴포즈 플러그인을 실행하고, 주문 서비스를 이 서비스가 의존하는 인프라 서비스와 함께 시동함
- 도커 이미지에 필요한 JAR 파일이 먼저 빌드되도록 componentTest가 assemble에 의존하도록 구성



### 3. 종단 간 테스트 작성

- 굳이 작성해야하면 사용자 탐험 테스트(user journey test)를 대신 작성하는 것이 좋다 : 사용자가 시스템을 돌아다니면서 여기저기 둘러보는 행위를 코드로 구현한 것
- 업무 담당자가 이해할 수 있는 고수준의 DSL로 작성하는게 좋다.
- 컴포넌트 테스트처럼 거킨으로 작성하고 큐컴버로 실행



