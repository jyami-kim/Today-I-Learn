# Chapter12. 마이크로서비스 배포

##### 프로덕션 환경의 4대 필수 기능

- 서비스 관리 인터페이스 (service management interface)
- 런타임 서비스 관리 (runtime service management)
- 모니터링 (monitoring)
- 요청 라우팅 (request routing)



##### 네가지 주요 배포 옵션

- 언어에 특정한 패키지로 서비스 배포 : jar, war
- 서비스를 가상 머신으로 배포
- 서비스를 컨테이너로 배포
- 서비스를 서버리스 배포 기술로 배포



### 1. 서비스 배포: 언어에 특정한 패키징 포맷 패턴

언어에 특정한 패키지 형태로 프로덕션에 배포한다.

필요한 런타임(JDK) 설치. WAR 파일로 배포하려면 웹 컨테이너도 설치해야 한다.



##### 장점

- 배포가 빠르다 : 파일을 그냥 복사해서 시동하면 되기 때문이다.
- 리소스를 효율적으로 활용할 수 있 : 여러 서비스가 인스턴스 머신과 OS를 공유해 리소스를 효율적으로 활용하는게 가능하다.

##### 단점

- 기술 스택을 캡슐화할 수 없다
- 서비스 인스턴스가 소비하는 리소스를 제한할 방법이 없다
- 여러 서비스 인스턴스가 동일 머신에서 실행될 경우 서로 격리할 수 없다.
- 서비스 인스턴스를 어디에 둘지 자동으로 결정하기 어렵다



### 2. 서비스 배포: 가상 머신 패턴

서비스를 vm 이미지로 묶어 프로덕션에 배포한다. 각 서비스 인스턴스가 하나의 vm이다.

vm 이미지를 생성하면 런타임에 생성이된다. : vm 이미지 빌드 툴은 되게 다양하다.



##### 장점

- vm 이미지로 기술스택을 캡슐화 한다
- 서비스 인스턴스가 격리된다
- 성숙한 클라우드 인프라를 활용한다



##### 단점

- 리소스를 효율적으로 활용할 수 없다
  서비스 인스턴스마다 OS 포함한 전체 가상머신의 오버헤드가 있음
  대부분 VM 크기가 한정되어있음
- 배포가 비교적 느리다 : VM이미지 크기가 커서 빌드시간도 오래걸린다
- 시스템 관리 오버헤드가 발생한다.



### 3. 서비스 배포: 컨테이너 패턴

서비스를 컨테이너 이미지로 묶어 프로덕션에 배포한다. 각 서비스 인스턴스가 곧 하나의 컨테이너다.

컨테이너를 생성할 때 CPU, 메모리, IO 리소스를 지정할 수 있다. 쿠버네티스같은 오케스트레이션 프레임워크를 사용할 경우에는 특히 리소스를 잘 지정해야한다.



#### 12.3.1. 서비스를 도커로 배포

컨테이너 이미지 : 애플리케이션과 서비스 구동에 필요한 모든 소프트웨어로 구성된 파일 시스템 이미지

1. 도커 이미지 빌드
2. 도커 이미지를 레지스트리에 푸시
   - 도커허브
   - 메이븐 센트럴
   - 도커 클라우드 레지스트리
   - AWS EC2 컨테이너 레지스트리
   - 프라이빗 레지스트리
3. 도커 컨테이너 실행



##### 컨테이너 패턴의 장점

- 기술스택의 캡슐화. 서비스 관리 API가 곧 컨테이너 API
- 서비스 인스턴스가 격리
- 서비스 인스턴스의 리소스를 제한할 수 있음

컨테이너는 가벼운 기술이고, 컨테이너 이미지는 빌드가 빠르다



##### 컨테이너 패턴의 단점

컨테이너 이미지를 직접 관리해야하는 부담이 있음

컨테이너 인프라 및 실행기반인 VM 인프라 직접 관리



### 4. 애플리케이션 배포: 쿠버네티스

도커를 기반으로 여러 머신을 하나의 서비스 실행 리소스 풀로 전환하는 소프트웨어 계층



#### 12.4.1. 쿠버네티스 개요

- 리소스 관리: 여러 머신을 CPU, 메모리, 스토리지 볼륨을 묶어 놓은 하나의 리소스 풀로 취급함
- 스케줄링: 컨테이너의 리소스 요건 및 노드별 리소스 상황에 따라 컨테이너를 실행할 머신을 선택함
- 서비스 관리: 마이크로서비스에 직접 매핑되는 서비스를 명명하고 버저닝함



##### 쿠버네티스 아키텍처

클러스터: 소수의 마스터와 하나이상의 노드로 구성

마스터: 클러스터를 관장함

노드: 하나 이상의 파드를 실행하는 워커

파드: 여러 컨테이너로 구성된 쿠버네티스의 배포 단위



노드는 아래 컴포넌트를 실행함

- 큐블릿
- 큐브 프록시
- 파드



##### 쿠버네티스 핵심개념

- 파드 (pod)
- 디플로이먼트 (deployment)
- 서비스 (service)
- 컨피그맵 (configmap)



#### 12.4.4. 무중단 배포

쿠버네티스는 파드를 롤링 업데이트를 한다.
deployment는 롤아웃이라는 이력을 관리하며, 업데이트를 할 때마다 롤아웃이 생성되서 롤백이 쉽다.



#### 12.4.5. 배포와 릴리스 분리: 서비스 메시

새 버전을 확실히 시작하려면 배포와 릴리스를 따로 분리하는게 상책이다

- 배포: 운영 환경에서 실행
- 서비스 릴리스: 최종 사용자에게 서비스를 제공



##### 이스티오 서비스 메시

마이크로서비스를 연결, 관리, 보안하는 오픈 플랫폼

- 컨트롤 플레인 : 데이터 플레인이 트래픽을 라우팅 하도록 구성하는 등의 관리역할
  - 파일럿 : 하부 인프라에서 배포된 서비스 관련 정보 추출
  - 믹서 : 엔보이 프록시에서 텔레메트리를 수집하고 정책을 집행하는 역할
- 데이터 플레인: 서비스 인스턴스인 엔보이 프록시로 구성(7계층 프록시)



### 5. 서비스 배포: 서버리스 패턴

##### 람다 함수 호출

- HTTP 요청
- AWS 서비스에서 생성된 이벤트
- 스케줄링된 호출
- API를 직접 호출



##### 람다함수의 장점

- 다양한 AWS 서비스와의 연계
- 시스템 관리 업무가 많이 경감됨
- 탄력성



##### 람다함수의 단점

- 긴-꼬리 지연: 코드를 동적실행해 AWS가 애플리케이션 인스턴스를 프로비저닝하고 애플리케이션을 시동하기 까지 시간이 걸린다
- 제한된 이벤트/ 요청 기반 프로그래밍 모델







