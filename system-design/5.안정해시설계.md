# 5. 안정 해시 설계

### 해시키 재배치(rehash) 문제

```
serverIndex = hash(key) % N (서버의개수)
```

서버 풀의 크기가 고정되어있고, 데이터 분포가 균등하면 잘 동작한다.

서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

대부분의 키가 재분배되고, 대부분 캐시 클라이언트가 데이터 없는 엉뚱한 서버에 접속하게 된다. 

대규모 캐시 미스 (cache miss) > 안정 해시는 이 문제를 효과적으로 해결함.



### 안정해시

해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술 
k : 키의 개수 / n : 슬롯의 개수 

SHA-1의 해시 공간 : 0 ~ 2^160-1

1. 해시서버 : 해시링 위에 해시함수 f를 사용하여 서버 IP나 이름을 링의 어떤 위치에 대응시킨다
   이때 f는 % 연산 사용을 하지 않고 있다.
2. 해시 키 : 캐시할 키도 해시링의 어느 지점에 배치가 가능하다.
3. 서버조회 : 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해나가면서 만나는 첫번재 서버
4. 서버 추가 : 키 가운데 일부만 재배치하면 된다.
5. 서버 제거 : 키 가운데 일부만 재배치된다.



### 기본 구현법의 두가지 문제

안정 해시 알고리즘은 MIT에서 처음 제안되었다.

https://en.wikipedia.org/wiki/Consistent_hashing

- 서버와 키를 균등 분포(uniform distribution)하여 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버

##### 두가지 문제

- 서버가 추가 삭제 감안하면 파티션의 크기를 균둥하게 유지하는게 불가능하다

  파티션 : 인접한 서버 사이의 해시 공간

  누구는 큰 해시공간, 누구는 작은 해시 공간을 받는다.

- 키의 균등 분포 (uniform distribution)을 달성하기 어렵다.



### 가상노드 기법

가상노드(virtual node) : 실제 노드 또는 서버를 가르키는 노드. 하나의 서버는 링위에 여러개의 가상 노드를 가질 수 있다.

가상노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. > 표준편차가 작아져서 데이터가 고르게 분포된다.

https://tom-e-white.com/2007/11/consistent-hashing.html :

- 100~200 개의 가상노드를 사용했을 경우 표준 편차 값은 평균의 5% 사이.
- 시스템 요구사항에 맞게 가상노드 데이터 저장공간과 표준 편차 사이를 잘 조절가능한 가상 노드개수를 선택하자

##### 키의 재배치

영향 범위 사이에 있는 서버들이 영향받는다. 

새로 추가된 노드 부터 그 반시계 방향에 있는 서버의 노드까지



### 안정해시의 예시

- 아마존 다이나모 데이터베이스의 파티셔닝 관련 컴포넌트
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카미아 CDN
- 메그레프 네트워크 부하분산기

